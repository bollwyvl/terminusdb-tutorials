#!/usr/bin/env bash
set -eux

# build swipl
mkdir $HOME/swipl_bld

cd $HOME/swipl_bld
wget -N https://www.swi-prolog.org/download/stable/src/swipl-8.2.1.tar.gz
tar -xvzf swipl-8.2.1.tar.gz
cd swipl-8.2.1

mkdir build
cd build
cmake -DCMAKE_INSTALL_PREFIX=${NB_PYTHON_PREFIX} -G Ninja ..
ninja
ninja install

# smoke test swipl
swipl -g "writeln('hello world')." -t 'halt.'

cd $HOME

rm -rf $HOME/swipl_bld

# install prolog package
cat << EOF > install.pl
:- initialization main.

install:-
        pack_install(terminus_store_prolog, [interactive(false)]).

main:-
        catch(install, E, (print_message(error, E), fail)),
        halt.
main:-
        halt(1).
EOF

swipl install.pl

# get server source
git clone https://github.com/terminusdb/terminusdb-server --depth=1

# install labextensions
jupyter labextension install --no-build --debug \
    @jupyter-widgets/jupyterlab-manager \
    jupyter-cytoscape \
    bqplot

# build lab
jupyter lab build --debug --minimize=False
